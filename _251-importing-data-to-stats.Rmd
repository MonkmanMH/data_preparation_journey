---
output:
  pdf_document: default
  html_document: default
---



```{r setup_ch251, include=FALSE, eval=TRUE}

source("package_load.R")

```


# Importing data for statistical software {#importing-2b}

In this chapter:

* Importing plain-text data and applying syntax from statistical software packages to apply labels and output as statistical software data formats, with an emphasis on SPSS.



## Creating a labelled dataframe from SPSS syntax


In the previous chapter, we imported data files that had been created using the software packages SAS\index{SAS}, SPSS\index{SPSS}, and Stata\index{Stata}. We also saw how to work with _labelled_ variables\index{labelled variables}. 

In our quest for data to analyze, we might come across a circumstance where an organization has collected survey data, and the data collectors have published the individual records, allowing researchers like you and me to further explore the data.

These data files contain individual records, rather than a data file that has been summarized with counts and percentages. A file with the individual records is sometimes referred to as a "micro-file", and one that has been anonymized for publication might be described as a Public-Use Micro File (abbreviated as "PUMF"\index{PUMF}).

In this chapter, we will look at two circumstances where the data collectors have done just that. But rather than releasing the micro-data in a variety of formats, they have published a bundle that contains the raw text flat file along with syntax (code) files that apply variable names, variable labels, and value labels. This is great if we have a license for one of those proprietary software tools^[Or a friend we can bribe with the promise of a chocolate bar.], but what if we are an R user?

Fortunately for us, there is a package that has functions to read a raw text file, and apply SPSS syntax to create an R object with labelled variables: {memisc} [@R-memisc].


`library(memisc)`

### National Travel Survey (NTS)

Our first example uses information from the National Travel Survey (NTS)\index{National Travel Survey (NTS)}, collected and published by Statistics Canada [@StatCan_NTS_2020]. 

Step 1 - Download the "SPSS" zip file for the 2020 reference period, and unzip it in the project sub-folder "data". This should create a sub-folder, so that the file path is now "data\\2020-spss"

The zip file does _not_ include an SPSS-format data file (.sav). Instead, the folder has a fixed-width text file for each of the three survey components (person, trips, and visits), and corresponding SPSS syntax files that can be used to read the files into the correct variables and to apply the variable and value labels. 

For this example, we will use the 2020 NTS "Person" file. The raw data file provided by Statistics Canada is "PERSON_NTS2020_PUMF.txt".


Step 2 - Use the SPSS syntax files (in R)


The bundle also includes separate SPSS syntax files with the ".sps" extension. Because Canada is a bilingual country, Statistics Canada releases two versions of the label syntax files, one in English and the other in French. They can be differentiated through the last letter of the file name, before the extension. These are:

* variable labels: "Person_NTS2020_Pumf_vare.sps" (The equivalent file with French variable labels is "Person_NTS2020_Pumf_varf.sps".)

* variable values: "Person_NTS2020_Pumf_vale.sps"

* missing values: "Person_NTS2020_Pumf_miss.sps"

This structure works very well with the {memisc} functions, and these files do not require any further manipulation. (As we will see in our second example, this is not always the case.)

Because Statistics Canada has made the data available from other years, we will consciously create flexible code that will permit us to rerun our code later with a minimum number of changes. Accordingly, we will assign the year of the data as an object.


```{r memisc_year}

nts_year <- "2020"

```

We can now use the object with the year number in a variety of ways, as we define the locations of the various input files. Note that this code uses the `glue()` function from the {glue} package to create the file name strings, and the `here()` function from the {here} package to determine the file path relative to our RStudio project location.


```{r memisc_inputs}

# define locations of input files

nts_year_format <- glue(nts_year, "-SPSS")

input_folder <- here("data", nts_year_format)
input_folder

layout_folder <- here("data", nts_year_format, "Layout_cards")
layout_folder

# use the above to create objects with file names and paths

data_file_1 <- glue("PERSON_NTS", nts_year, "_PUMF.txt")
data_file <- glue(input_folder, "/Data_Données/", data_file_1)
data_file

columns_file_1 <- glue("Person_NTS", nts_year, "_Pumf_i.sps")
columns_file <- glue(layout_folder, columns_file_1, .sep = "/")
columns_file

variable_labels_1 <- glue("Person_NTS", nts_year, "_Pumf_vare.sps")
variable_labels <- glue(layout_folder, variable_labels_1, .sep = "/")


variable_values_1 <- glue("Person_NTS", nts_year, "_Pumf_vale.sps")
variable_values <- glue(layout_folder, variable_values_1, .sep = "/")

missing_values_1 <- glue("Person_NTS", nts_year, "_Pumf_miss.sps")
missing_values <- glue(layout_folder, missing_values_1, .sep = "/")


```


The next stage is to create a definition of the dataset using the `memisc::spss.fixed.file()` import procedure.

```{r memisc_import}

# read file, create datafile with nested lists
nts_person_2020 <- spss.fixed.file(
  data_file,
  columns_file,
  varlab.file = variable_labels,
  codes.file = variable_values,
  missval.file = missing_values,
  count.cases = TRUE,
  to.lower = TRUE
)

# convert the resulting object into a "data.set" format 
nts_person_2020_ds <- as.data.set(nts_person_2020)

```


Do we need this?

```{r eval=FALSE}

outlist <- c("nts_person_2020_ds")

#save(list=outlist,file="sfs2016_efam_save.Rsave")
save(list=outlist, file = here("data_output", "nts_person_2020_ds.RSave"))

```



The last step is to convert our dataset object into a tibble. This tibble has all of the labels assigned, accessible via the functions in the {labelled} package.


```{r convert_to_haven_tibble}

nts_person_2020_hav <- as_haven(nts_person_2020_ds)
nts_person_2020_hav

```


In our final step, we will save the dataframe as an SPSS, Stata, and RDS files for future use.

One important note for Stata users is that there is a "version" argument, which allows us to create a file that can be read by older versions of Stata (the default is Stata 15).


```{r export, eval=FALSE}
# export haven format table as SPSS .sav file
haven::write_sav(nts_person_2020_hav,
                 here("data_output", "nts_person_2020.sav"))

# export haven format table as Stata .dta file
haven::write_dta(nts_person_2020_hav,
                 here("data_output", "nts_person_2020.13.dta"),
                 version = 13)


# export RDS 
readr::write_rds(nts_person_2020_hav,
                 here("data_output", "nts_person_2020.rds"))

```





### American Time Use Survey (ATUS)

In every year since 2003, the US Census Bureau has undertaken the American Time Use Survey (ATUS)\index{American Time Use Survey(ATUS)} on behalf of the Bureau of Labor Statistics.

Survey purpose: "The goal of the survey is to 
measure how people divide their time among life’s activities." This sample of Americans provides estimates of how much time people spend on unpaid activities such as childcare, eldercare, and housework, as well as other activities like socializing and exercising. There is also information about where and with whom those activities occurred, along with demographic information about the individual. [USBLS_ATUS_2022, American Time Use Survey User’s Guide: Understanding ATUS 2003 to 2021, p.3]

R package?

R examples of using the ATUS?

The Bureau of Labor Statistics (BLS) publishes a set of PUMF files with the annual results of the ATUS. Similarly to the NTS, the data files are released as flat files, along with companion syntax files for Stata, SAS, and SPSS users.

The syntax files require a bit of manipulation before we can apply the {memisc} functions we used above.

For this example, we will focus on the 2019 "activity" file of the ATUS. This file contains just over 182,000 individual activities, recorded for the [XYZ] respondents to the survey; each activity has its own record (row) in the data.





<!-- 
This file by Martin Monkman is licensed under a Creative Commons Attribution 4.0 International License. 
-->

